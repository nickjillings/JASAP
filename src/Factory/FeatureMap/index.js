/* jshint esversion: 6 */

import FeatureNode from "./FeatureNode";
import SourceMap from "./SourceMap";

export default function FeatureMap() {
    var Mappings = [];

    function getFeatureNode(list, check) {
        return list.find(function (e) {
            return e.name === this.name;
        }, check);
    }

    function addFeatureNode(featureNode, list) {
        var node = new FeatureNode(featureNode);
        list.push(node);
        return node;
    }

    function findSourceIndex(Sender) {
        return Mappings.findIndex(function (e) {
            return e.getSender() === this;
        }, Sender);
    }

    function findSourceMap(Mappings, source, pluginSender) {
        var sourceMap = Mappings[findSourceIndex(source)];
        if (!sourceMap) {
            sourceMap = Mappings[findSourceIndex(pluginSender)];
            if (!sourceMap) {
                throw ("Could not locate source map");
            }
        }
        return sourceMap;
    }

    // GENERAL INTERFACE
    this.createSourceMap = function (Sender, pluginInstance) {
        var node = new SourceMap(Sender, pluginInstance);
        Mappings.push(node);
        return node;
    };
    this.deleteSourceMap = function (Sender) {
        var index = findSourceIndex(Sender);
        if (index === -1) {
            throw ("Could not find the source map for the plugin");
        }
        Mappings.splice(index, 1);
    };

    this.getPluginSender = function (plugin) {
        if (plugin.constructor === PluginInstance) {
            plugin = plugin.node;
        }
        return plugin.featureMap.Sender;
    };

    this.requestFeatures = function (requestor, source, featureObject) {
        if (requestor.constructor !== PluginInstance) {
            requestor = requestor.pluginInstance;
        }
        // Get the source map
        var pluginSender = this.getPluginSender(source);
        var sourceMap = findSourceMap(Mappings, source, pluginSender);
        sourceMap.requestFeatures(requestor, featureObject);
    };
    this.deleteFeatures = function (requestor, source, featureObject) {
        if (requestor.constructor !== PluginInstance) {
            requestor = requestor.pluginInstance;
        }
        if (source === undefined) {
            Mappings.forEach(function (sourceMap) {
                sourceMap.cancelFeatures(requestor);
            });
        } else {
            // Get the source map
            var pluginSender = this.getPluginSender(source);
            var sourceMap = findSourceMap(Mappings, source, pluginSender);
            sourceMap.cancelFeatures(requestor, featureObject);
        }
    };
    this.getFeatureList = function (requestor, source) {};
    this.postFeatures = function (featureObject) {
        // Receive from the Sender objects
        // Trigger distributed search for results transmission

        // First get the instance mapping for output/frame
        var source = Mappings[findSourceIndex(featureObject.plugin)];
        if (!source) {
            source = Mappings[findSourceIndex(this.getPluginSender(featureObject.plugin))];
            if (!source) {
                throw ("Plugin Instance not loaded!");
            }
        }
        var frameMap = source.findFrameMap(featureObject.outputIndex, featureObject.frameSize);

        // Send the feature object to the RequestorMap object to handle comms
        frameMap.requestors.forEach(function (e) {
            e.postFeatures(this);
        }, featureObject);

    };
}
