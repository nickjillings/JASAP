/* jshint esversion: 6 */

import OutputNode from "./OutputNode";

export default function SubFactoryFeatureSender(owner, FactoryFeatureMap) {
    var outputNodes;
    this.updateFeatures = function (featureObject) {
        var o;
        for (o = 0; o < featureObject.length; o++) {
            if (outputNodes === undefined) {
                if (o > 1) {
                    throw ("Requested an output that does not exist");
                }
                outputNodes = new OutputNode(owner, owner.chainStart);
                Object.defineProperty(outputNodes, "postFeatures", {
                    'value': function (resultObject) {
                        this.postFeatures(resultObject);
                    }.bind(this)
                });
            }
            var si;
            for (si = 0; si < featureObject[o].length; si++) {
                var extractor = outputNodes.findExtractor(featureObject[o][si].frameSize);
                if (!extractor) {
                    extractor = outputNodes.addExtractor(featureObject[o][si].frameSize);
                }
                extractor.setFeatures(featureObject[o][si].featureList);
            }
        }
    };

    this.rejoinExtractors = function () {
        if (outputNodes) {
            outputNodes.rejoinExtractors();
        }
    };

    this.postFeatures = function (featureObject) {
        /*
            Called by the individual extractor instances:
            featureObject = {'frameSize': frameSize,
            'outputIndex': outputIndex,
            'results':[]}
        */
        FactoryFeatureMap.postFeatures({
            'plugin': this,
            'outputIndex': featureObject.outputIndex,
            'frameSize': featureObject.frameSize,
            'results': featureObject.results
        });
    };

    this.destroy = function() {
        FactoryFeatureMap.deleteSourceMap(this);
    }

    // Send to Factory
    FactoryFeatureMap.createSourceMap(this, undefined);
}
